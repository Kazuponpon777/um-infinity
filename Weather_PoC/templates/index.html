<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>UM-Infinity Web Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #1a1a1a; color: #e0e0e0; margin: 0; padding: 20px; }
        h1 { border-bottom: 2px solid #50e3c2; padding-bottom: 10px; color: #50e3c2; font-size: 24px; }
        .container { max-width: 1200px; margin: 0 auto; background: #252525; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        #map { height: 600px; width: 100%; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444; }
        
        /* Controls Area */
        .controls-area {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            align-items: center;
            background: #333;
            padding: 15px;
            border-radius: 8px;
        }
        
        button {
            background: #50e3c2;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        button:hover { background: #3dd1b0; }
        button:disabled { background: #555; cursor: not-allowed; color: #888; }
        
        input[type="datetime-local"] {
            background: #222;
            color: #fff;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
        }
        
        .loading { color: #f5a623; font-weight: bold; margin-left: 10px; display: none; }
        
        .factors { display: flex; gap: 20px; margin-bottom: 30px; }
        .card { background: #333; padding: 15px; border-radius: 5px; flex: 1; text-align: center; }
        .card h3 { margin: 0 0 5px 0; font-size: 0.8em; color: #aaa; }
        .card .val { font-size: 1.4em; font-weight: bold; color: #fff; }
        .card .desc { font-size: 0.7em; color: #888; margin-top: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th { text-align: left; border-bottom: 1px solid #555; padding: 10px; color: #888; }
        td { padding: 10px; border-bottom: 1px solid #333; }
        tr:hover { background: #2a2a2a; }
        
        .risk-LOW { color: #50e3c2; }
        .risk-MODERATE { color: #f5a623; }
        .risk-HIGH { color: #ff5e3a; font-weight: bold; }
        .risk-EXTREME { color: #ff0055; font-weight: bold; text-shadow: 0 0 5px #ff0055; }
        
        .desc-col { color: #ccc; }
        .region-col { font-weight: bold; color: #fff; font-size: 1.1em; }
        .coord-col { font-size: 0.8em; color: #777; }
        
        .footer { margin-top: 30px; font-size: 0.8em; color: #666; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>UM∞N Web Dashboard "The Eye"</h1>
        
        <div class="controls-area">
            <button onclick="fetchData('now')">⚡ Real-time (現在)</button>
            <span style="color:#666">|</span>
            <label style="color:#ccc">Time Machine:</label>
            <input type="datetime-local" id="datePicker">
            <button onclick="fetchDate()">Go (過去へ)</button>
            <span class="loading" id="loadingIndicator">Analyzing...</span>
        </div>
        
        <p style="text-align:center; margin-bottom:10px;">
            表示データ: <span id="dataTimestamp" style="color:#50e3c2; font-weight:bold;">---</span>
        </p>
        
        <div id="map"></div>
        
        <div class="factors">
            <div class="card"><h3>宇宙天気 (Space)</h3><div class="val" id="valSpace">-</div></div>
            <div class="card"><h3>地磁気 (Geomag)</h3><div class="val" id="valGeomag">-</div></div>
            <div class="card"><h3>都市 (Urban)</h3><div class="val" id="valUrban">-</div></div>
            <div class="card"><h3>心理 (Bio)</h3><div class="val" id="valBio">-</div></div>
        </div>
        
        <h2>リスク検出地域 (Top 20)</h2>
        <table>
            <thead>
                <tr>
                    <th>地域 / 座標</th>
                    <th>AI予測・現象解説</th>
                    <th>気温 / 湿度</th>
                    <th>GUP指数</th>
                    <th>危険度</th>
                </tr>
            </thead>
            <tbody id="riskTableBody">
                <!-- Dynamic -->
            </tbody>
        </table>

        <!-- Alert History Section -->
        <h2 style="margin-top: 40px; border-bottom: 2px solid #ff5e3a; color: #ff5e3a;">⚠️ 過去のアラート履歴 (Saving...)</h2>
        <div style="max-height: 200px; overflow-y: auto; background:#333; border-radius:5px;">
            <table style="margin-top:0;">
                <tbody id="alertHistoryBody">
                    <!-- Dynamic -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            解析理論: UM∞N (Information-Theoretic Quantum Gravity)<br>
            Powered by Python Flask Server & Local Archive
        </div>
    </div>

    <script>
        var map = L.map('map').setView([38.0, 137.0], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        var layerGroup = L.layerGroup().addTo(map);

        function setLoading(isLoading) {
            document.getElementById('loadingIndicator').style.display = isLoading ? 'inline' : 'none';
        }

        async function fetchDate() {
            const picker = document.getElementById('datePicker');
            if(!picker.value) { alert("日付を選択してください"); return; }
            // Format: YYYY-MM-DDTHH:mm -> YYYY-MM-DD-HH
            const d = new Date(picker.value);
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const day = String(d.getDate()).padStart(2,'0');
            const h = String(d.getHours()).padStart(2,'0');
            const dateStr = `${y}-${m}-${day}-${h}`;
            
            fetchData(dateStr);
        }

        async function fetchData(dateParam) {
            setLoading(true);
            try {
                const res = await fetch(`/api/analyze?date=${dateParam}`);
                if(!res.ok) throw new Error("Server Error");
                const data = await res.json();
                
                if(data.error) {
                    alert("エラー: " + data.error);
                } else {
                    renderDashboard(data);
                }
            } catch(e) {
                console.error(e);
                if (e.message === "Server Error") {
                    // Handled above (alerted data.error)
                } else {
                    alert("サーバーに接続できません。\nターミナルで 'python3 server.py' が実行されているか確認してください。");
                }
            }
            setLoading(false);
        }

        function renderDashboard(snap) {
            // Update Timestamp
            document.getElementById('dataTimestamp').innerText = snap.timestamp + " (JST)";
            
            // Update Factors
            document.getElementById('valSpace').innerText = snap.space.toFixed(2);
            document.getElementById('valGeomag').innerText = snap.geomag.toFixed(2);
            document.getElementById('valUrban').innerText = snap.urban.toFixed(2);
            document.getElementById('valBio').innerText = snap.bio.toFixed(2);
            
            // Update Map
            layerGroup.clearLayers();
            snap.results.forEach(p => {
                var radius = Math.min(Math.abs(p.grand_potential) * 500, 50000);
                if (radius < 5000) radius = 5000;
                
                L.circle([p.lat, p.lon], {
                    color: p.risk_color,
                    fillColor: p.risk_color,
                    fillOpacity: 0.5,
                    radius: radius
                }).addTo(layerGroup)
                .bindPopup(`<b>${p.region}</b><br>Risk: ${p.grand_potential.toFixed(1)}<br>${p.desc}`);
            });
            
            // Update Table
            var tbody = document.getElementById('riskTableBody');
            tbody.innerHTML = "";
            snap.results.slice(0, 20).forEach(res => {
                var tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <span class="region-col">${res.region}付近</span><br>
                        <span class="coord-col">${res.lat.toFixed(3)}, ${res.lon.toFixed(3)}</span>
                    </td>
                    <td class="desc-col">${res.desc}</td>
                    <td>
                        ${res.temp.toFixed(1)}℃<br>
                        ${res.humidity.toFixed(0)}%
                    </td>
                    <td><strong>${res.grand_potential.toFixed(1)}</strong></td>
                    <td class="risk-${res.risk_cls}">${res.risk_label}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        async function fetchAlerts() {
            try {
                const res = await fetch('/api/alerts');
                const alerts = await res.json();
                const tbody = document.getElementById('alertHistoryBody');
                tbody.innerHTML = "";
                
                if(alerts.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; color:#666;'>履歴なし</td></tr>";
                    return;
                }
                
                alerts.forEach(a => {
                    const tr = document.createElement('tr');
                    tr.style.cursor = 'pointer';
                    tr.onclick = () => {
                        // Set picker and load
                        const isoStr = a.timestamp.replace(' ', 'T').substring(0, 16);
                        document.getElementById('datePicker').value = isoStr;
                        fetchData(a.timestamp.replace(' ', '-').substring(0, 13)); // YYYY-MM-DD-HH
                    };
                    
                    tr.innerHTML = `
                        <td style="color:#aaa;">${a.timestamp}</td>
                        <td style="font-weight:bold; color:#fff;">${a.region}</td>
                        <td class="risk-HIGH">GUP: ${a.gup.toFixed(1)} (${a.risk_label})</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) { console.error("Alert fetch failed", e); }
        }
        
        // Initial Fetch
        fetchData('now');
        fetchAlerts();
    </script>
</body>
</html>
